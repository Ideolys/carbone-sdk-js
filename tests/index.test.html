<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carbone Render API example</title>
  </head>
  <body>
    <h1>Carbone Render API example</h1>

    <h2>Add a template</h2>

    <input type="file" id="templateInput" name="template" />

    <button onclick="addTemplate()">Upload the template</button>

    <h2>Render the report</h2>

    <input type="text" id="templateIdInput" placeholder="template ID" />

    <button onclick="renderReport()">Render</button>

    <span id="reportURL"></span>

    <script src="../dist/carboneRenderSDK.js"></script>
    <script>

      const _token = "test_eyJhbGciOiJFUzUxMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiIxNjY3IiwiYXVkIjoiY2FyYm9uZSIsImV4cCI6MjIyNzMzODkzOCwiZGF0YSI6eyJpZEFjY291bnQiOjE2Njd9fQ.Abwgnv8yNFil1SM9ZVCNgliNZ3XS5H06de4m8vagJKZBkxbXTL5S8s5o8HWjvTF7Nbb2BwTq_jO7e4_lrX2BJ-0fAeoRhJa78oC7_yY2yHIOL_7voIAthG9EFlvPtkUUczP9yLnG4FD4fWkc5h8I5Y_4WrMC8X2dOUHIEdi8RsiuUdy6";
      const carboneService = window.carboneRenderSDK(_token);

      async function addTemplate() {
        if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
          console.log("The File APIs are not fully supported in this browser.");
          return;
        }
        var input = document.getElementById("templateInput");
        if (!input) {
          console.log("Um, couldn't find the fileinput element.");
        } else if (!input.files) {
          console.log(
            "This browser doesn't seem to support the `files` property of file inputs."
          );
        } else if (!input.files[0]) {
          console.log("Please select a file before clicking 'Load'");
        } else {
          var file = input.files[0];
          carboneService.addTemplate(file, "").then(data => {
            if (data.success === true) {
              document.getElementById("templateIdInput").value = data.data.templateId;
              console.log(data.data.templateId);
            } else {
              console.error("Add template error: something went wrong");
            }
          });
        }
      }

      function renderReport() {
        document.getElementById("reportURL").innerHTML = "";
        const _templateID = document.getElementById("templateIdInput").value;

        if (!_templateID) {
          console.error("The template ID is not specified");
          document.getElementById("reportURL").innerHTML =
            "The template ID is not specified";
          return;
        }
        const _data = { firstname: "John", lastname: "Wick" };

        // CALL RENDER
        if (data && data.success === true) {
          document.getElementById("reportURL").innerHTML =
            "<h2> Report </h2><br/> render Id: " +
            data.data.renderId +
            "<br/><br/> report URL (click to download): <a href='https://render.carbone.io/render/" +
            data.data.renderId +
            "' download>https://render.carbone.io/render/" +
            data.data.renderId +
            "</a>";
        } else {
          document.getElementById("reportURL").innerHTML =
            "Something went wrong during rendering";
        }

      }

      async function getTemplateId(fileContent, payload) {
        function arrayBufferToHex(buffer) {
          var digest = ''
          var view = new DataView(buffer)
          for(var i = 0; i < view.byteLength; i += 4) {
            // We use getUint32 to reduce the number of iterations (notice the `i += 4`)
            var value = view.getUint32(i)
            // toString(16) will transform the integer into the corresponding hex string
            // but will remove any initial "0"
            var stringValue = value.toString(16)
            // One Uint32 element is 4 bytes or 8 hex chars (it would also work with 4
            // chars for Uint16 and 2 chars for Uint8)
            var padding = '00000000'
            var paddedValue = (padding + stringValue).slice(-padding.length)
            digest += paddedValue
          }
          return digest
        }
      if  (!payload) {
        payload = '';
      }
      var bufferContent = new TextEncoder("utf-8").encode(payload + fileContent)
      return await crypto.subtle.digest("SHA-256", bufferContent).then(function(hash) {
        console.log(arrayBufferToHex(hash));
      })
    }
    getTemplateId("<html>This is some content</html>");
    getTemplateId("<html>This is some content</html>", "Payload1234");
    </script>
  </body>
</html>
